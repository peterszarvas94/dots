#!/bin/bash

# ESM Package Downloader
# Usage: esm package [options]
# Example: esm pocketbase -v 0.26.3 -f scripts

show_help() {
    echo "ESM Package Downloader"
    echo "Usage: esm package [options]"
    echo ""
    echo "Examples:"
    echo "  esm pocketbase -v 0.26.3 -d scripts"
    echo "  esm pocketbase --version 0.26.3 --dir \"my folder\""
    echo "  esm lodash --version 4.17.21 --dir lib"
    echo "  esm react -d components"
    echo ""
    echo "Options:"
    echo "  -v, --version VER   Package version (default: latest)"
    echo "  -d, --dir DIR       Download to specified directory (default: current directory)"
    echo "  -h, --help          Show this help message"
}

# Default values
FOLDER="."
PACKAGE=""
PKG_VERSION="latest"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --version|-v)
            PKG_VERSION="$2"
            shift 2
            ;;
        --dir|-d)
            FOLDER="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            show_help
            exit 1
            ;;
        *)
            if [[ -z "$PACKAGE" ]]; then
                PACKAGE="$1"
                PKG_NAME="$1"
            else
                echo "Error: Multiple packages specified" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate package argument
if [[ -z "$PACKAGE" ]]; then
    echo "Error: Package name required" >&2
    show_help
    exit 1
fi

# If version is "latest", fetch the actual latest version number
if [[ "$PKG_VERSION" == "latest" ]]; then
    echo "Fetching latest version for $PKG_NAME..."
    LATEST_VERSION=$(curl -s "https://registry.npmjs.org/$PKG_NAME/latest" | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
    
    if [[ -n "$LATEST_VERSION" ]]; then
        PKG_VERSION="$LATEST_VERSION"
        echo "Latest version: $PKG_VERSION"
    else
        echo "Warning: Could not fetch latest version, using 'latest' as fallback"
    fi
fi

# Create folder if it doesn't exist
if [[ ! -d "$FOLDER" ]]; then
    echo "Creating directory: $FOLDER"
    mkdir -p "$FOLDER"
fi

# Generate output filename
OUTPUT_FILE="$FOLDER/${PKG_NAME}@${PKG_VERSION}.js"

# Download URL - try bundle first, fallback to direct
BUNDLE_URL="https://esm.sh/${PKG_NAME}@${PKG_VERSION}?bundle"

echo "Downloading $PKG_NAME@$PKG_VERSION to $OUTPUT_FILE..."

# First attempt: try to get the bundle
curl -s -o "$OUTPUT_FILE" "$BUNDLE_URL"

# Check if we got a redirect file (small size indicates redirect)
FILE_SIZE=$(wc -c < "$OUTPUT_FILE")

if [[ $FILE_SIZE -lt 1000 ]]; then
    echo "Got redirect, following to actual bundle..."
    
    # Extract the real URL from the redirect file
    REAL_URL=$(grep -o '/[^"]*\.mjs' "$OUTPUT_FILE" | head -n1)
    
    if [[ -n "$REAL_URL" ]]; then
        FULL_URL="https://esm.sh${REAL_URL}"
        echo "Downloading from: $FULL_URL"
        curl -s -o "$OUTPUT_FILE" "$FULL_URL"
    else
        echo "Warning: Could not find bundle URL, trying direct download..."
        DIRECT_URL="https://esm.sh/${PKG_NAME}@${PKG_VERSION}"
        curl -s -o "$OUTPUT_FILE" "$DIRECT_URL"
    fi
fi

# Verify download
if [[ -f "$OUTPUT_FILE" ]]; then
    FINAL_SIZE=$(wc -c < "$OUTPUT_FILE")
    echo "✅ Successfully downloaded $PKG_NAME@$PKG_VERSION"
    echo "   File: $OUTPUT_FILE"
    echo "   Size: $(echo "scale=1; $FINAL_SIZE/1024" | bc 2>/dev/null || echo $((FINAL_SIZE/1024)))KB"
else
    echo "❌ Failed to download $PKG_NAME@$PKG_VERSION"
    exit 1
fi
